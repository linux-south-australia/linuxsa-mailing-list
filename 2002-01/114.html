<HTML>
<!-- EmailData="Start" -->
<!-- Version="1.1" -->
<!-- Subject="iptables FTP SNAT problem..." -->
<!-- FromName="'Richard Russell'" -->
<!-- FromEmail="richard@yellowgoanna.com" -->
<!-- ToName="'LinuxSA Mailing List'" -->
<!-- ToEmail="linuxsa@linuxsa.org.au" -->
<!-- Date="Thu, 10 Jan 2002 06:43:02 +1030" -->
<!-- Id="000801c1994a$0a9633d0$0b00a8c0@albert" -->
<!-- Reference="" -->
<!-- X-Face="" -->
<!-- X-URL="" -->
<!-- EmailData="End" -->
<HEAD>
<TITLE>LinuxSA Mailing List: iptables FTP SNAT problem...</TITLE>
</HEAD>
<BODY BGCOLOR=#FFFFFF><H1>LinuxSA Mailing list archives</H1>
<!-- IndexControl1="Start" -->
Index:
[<A HREF="thread.html">thread</A>]
[<A HREF="date.html">date</A>]
[<A HREF="subject.html">subject</A>]
[<A HREF="author.html">author</A>]
[<A HREF="stats.html">stats</A>]
<HR>
<!-- IndexControl1="End" -->
<!-- Header="Start" -->
<PRE>
  From: Richard Russell &lt;<I><A HREF="mailto:richard@yellowgoanna.com">richard@yellowgoanna.com</A></I>&gt;
  To  : LinuxSA Mailing List &lt;<I><A HREF="mailto:linuxsa@linuxsa.org.au">linuxsa@linuxsa.org.au</A></I>&gt;
  Date: Thu, 10 Jan 2002 06:43:02 +1030
</PRE>
<H1>iptables FTP SNAT problem...</H1>
<!-- Header="End" -->
<!-- Body="Start" -->
<PRE>
OK, I have a problem. I've looked at it for some time, and I've read all
the HOWTOs and google-linked documents I can find, and I just can't see
what I've done wrong... I've even searched the LinuxSA archives, to no
avail...

Situation is that I have a RH7.2 server (kernel 2.4.9-13, iptables
1.2.3) and a LAN. It is inconvenient for me to get to the LAN itself for
testing, and the only FTP available there is in a Macromedia program...
So, I'm mostly restricted to using the server, which is OK when
everything works as I expect (still a little annoying, but that's life).


Anyway, So I'm trying to set up SNAT (Masquerading) for the LAN, and
every time I test FTP, I get an error (that varies a little depending on
the version of software) that effectively says can't find host, or can't
connect to host... I can FTP fine from the server...

Now the grisly details:

Server:
int	eth0	192.168.x.y
ext	eth1	a.b.c.d

Here's the content of my tables (firstly in the RH config file, then
from output generated by iptables below):

----
[<A HREF="mailto:root@server">root@server</A> root]# more /etc/sysconfig/iptables
# Generated by iptables-save v1.2.3 on Thu Nov 29 14:26:47 2001
*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
[0:0] -A POSTROUTING -o eth1 -j SNAT --to-source a.b.c.d
COMMIT
# Completed on Thu Nov 29 14:26:47 2001
# Generated by iptables-save v1.2.3 on Thu Nov 29 14:26:47 2001
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:state_chk - [0:0]
[0:0] -A INPUT -j state_chk
[0:0] -A FORWARD -j state_chk
[0:0] -A state_chk -m state --state RELATED,ESTABLISHED -j ACCEPT
[0:0] -A state_chk -p icmp -m state --state NEW -j ACCEPT
[0:0] -A state_chk -i eth0 -m state --state NEW -j ACCEPT
[0:0] -A state_chk -i lo -m state --state NEW -j ACCEPT
[0:0] -A state_chk -i eth1 -p tcp -m state --state NEW -m tcp --dport 22
-j ACCEPT
[0:0] -A state_chk -i eth1 -p tcp -m state --state NEW -m tcp --dport 25
-j ACCEPT
[0:0] -A state_chk -j REJECT --reject-with icmp-port-unreachable
COMMIT
# Completed on Thu Nov 29 14:26:47 2001

----




Now iptables output

The filter table (not really relevant)
----
[<A HREF="mailto:root@server">root@server</A> root]# iptables -L -v -t filter
Chain INPUT (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source
destination
60127   34M state_chk  all  --  any    any     anywhere
anywhere

Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source
destination
    0     0 state_chk  all  --  any    any     anywhere
anywhere

Chain OUTPUT (policy ACCEPT 67080 packets, 34M bytes)
 pkts bytes target     prot opt in     out     source
destination

Chain state_chk (2 references)
 pkts bytes target     prot opt in     out     source
destination
57549   34M ACCEPT     all  --  any    any     anywhere
anywhere           state RELATED,ESTABLISHED
    3    84 ACCEPT     icmp --  any    any     anywhere
anywhere           state NEW
  709 75271 ACCEPT     all  --  eth0   any     anywhere
anywhere           state NEW
 1549 92892 ACCEPT     all  --  lo     any     anywhere
anywhere           state NEW
    1    60 ACCEPT     tcp  --  eth1   any     anywhere
anywhere           state NEW tcp dpt:ssh
    0     0 ACCEPT     tcp  --  eth1   any     anywhere
anywhere           state NEW tcp dpt:smtp
  316 12711 REJECT     all  --  any    any     anywhere
anywhere           reject-with icmp-port-unreachable
----

The nat table (most relevant)
----
[<A HREF="mailto:root@server">root@server</A> root]# iptables -L -v -t nat
Chain PREROUTING (policy ACCEPT 1259 packets, 100K bytes)
 pkts bytes target     prot opt in     out     source
destination

Chain POSTROUTING (policy ACCEPT 6903 packets, 399K bytes)
 pkts bytes target     prot opt in     out     source
destination
 1079 66522 SNAT       all  --  any    eth1    anywhere
anywhere           to:a.b.c.d

Chain OUTPUT (policy ACCEPT 8088 packets, 472K bytes)
 pkts bytes target     prot opt in     out     source
destination
----

The mangle table is just policy ACCEPT...

Thrills.


OK, here's my routing table:

----
[<A HREF="mailto:root@serer">root@serer</A> root]# netstat -rn
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt
Iface
a.b.c.e         0.0.0.0         255.255.255.252 U        40 0          0
eth1
192.168.x.0     0.0.0.0         255.255.255.0   U        40 0          0
eth0
127.0.0.0       0.0.0.0         255.0.0.0       U        40 0          0
lo
0.0.0.0         a.b.c.d         0.0.0.0         UG       40 0          0
eth1
----


And the part you've all been waiting for, lsmod

----
[<A HREF="mailto:root@server">root@server</A> root]# lsmod |grep ip
ip_conntrack_ftp        3920   0  (unused)
ip_nat_ftp              3584   0  (unused)
iptable_mangle          2160   0  (autoclean) (unused)
ipt_REJECT              3520   1  (autoclean)
ipt_state               1056   6  (autoclean)
iptable_nat            17744   1  (autoclean) [ip_nat_ftp]
ip_conntrack           16688   3  (autoclean) [ip_conntrack_ftp
ip_nat_ftp ipt_state iptable_nat]
iptable_filter          2160   0  (autoclean) (unused)
ip_tables              11712   7  [iptable_mangle ipt_REJECT ipt_state
iptable_nat iptable_filter]
----

As far as I can tell, I should be right.

Can anyone spot the problem here? I can't. I have all the Iptables ftp
modules ins'd, my routing table is correct, my rules seem sensible (if a
little on the weak side). Sigh.

Also, does anyone know of a way to test SNAT from the server itself? Can
I generate packets that will appear as if they came from the wire?

TIA

rr

-- 
Richard Russell
Yellow Goanna Pty Ltd
e: <A HREF="mailto:richard@yellowgoanna.com">richard@yellowgoanna.com</A>
m: +61 412 827 805
f: +61 8 8462 2362
 

-- 
LinuxSA WWW: <A HREF="http://www.linuxsa.org.au/">http://www.linuxsa.org.au/</A>  IRC: #linuxsa on irc.linux.org.au
To unsubscribe from the LinuxSA list:
  mail <A HREF="mailto:linuxsa-request@linuxsa.org.au">linuxsa-request@linuxsa.org.au</A> with "unsubscribe" as the subject

</PRE>
<!-- Body="End" -->
<!-- IndexControl2="Start" -->
<HR>
Index:
[<A HREF="thread.html">thread</A>]
[<A HREF="date.html">date</A>]
[<A HREF="subject.html">subject</A>]
[<A HREF="author.html">author</A>]
[<A HREF="stats.html">stats</A>]
<!-- IndexControl2="End" -->
<HR><FONT SIZE=+1>Return to the <A HREF=/mailing-list/>LinuxSA Mailing List Information</A> Page</FONT></BODY>
</HTML>
